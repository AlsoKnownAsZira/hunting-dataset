<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>YOLOv11 FastAPI — Live Webcam</title>
  <style>
    body{font-family:system-ui;margin:16px}
    .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap}
    video,canvas{border:1px solid #ddd;border-radius:12px;max-width:640px}
    .card{padding:12px;border:1px solid #eee;border-radius:12px;min-width:260px}
    label{display:inline-block;width:110px}
    #legend{font-size:12px;color:#555}
  </style>
</head>
<body>
<h2>YOLOv11 — Live Webcam (no button)</h2>

<div class="row">
  <div class="card">
    <div>
      <label>Confidence</label>
      <input id="conf" type="range" min="0.05" max="0.9" step="0.05" value="0.25">
      <span id="confv">0.25</span>
    </div>
    <div>
      <label>IoU (NMS)</label>
      <input id="iou" type="range" min="0.2" max="0.9" step="0.05" value="0.45">
      <span id="iouv">0.45</span>
    </div>
    <div>
      <label>imgsz</label>
      <select id="imgsz"><option>320</option><option selected>480</option><option>640</option></select>
    </div>
    <div>
      <label>max_det</label>
      <select id="maxdet"><option>20</option><option selected>50</option><option>100</option></select>
    </div>
    <p id="status">Status: idle</p>
    <p id="legend">Tips: turunkan imgsz/naikkan conf jika terasa berat.</p>
  </div>

  <div>
    <video id="cam" autoplay playsinline muted width="640" height="480"></video>
    <canvas id="view" width="640" height="480"></canvas>
  </div>
</div>

<script>
const conf = document.getElementById('conf');
const iou  = document.getElementById('iou');
const imgsz= document.getElementById('imgsz');
const maxdet=document.getElementById('maxdet');
const confv= document.getElementById('confv');
const iouv = document.getElementById('iouv');
const cam  = document.getElementById('cam');
const view = document.getElementById('view');
const ctx  = view.getContext('2d');
const statusEl = document.getElementById('status');

conf.oninput=()=>confv.textContent=conf.value;
iou.oninput =()=>iouv.textContent=iou.value;

let running = false;
let lastSent = 0;
const TARGET_FPS = 6;                 // ~6 FPS: hemat CPU server
const FRAME_INTERVAL = 1000 / TARGET_FPS;
const cap = document.createElement('canvas');
const capCtx = cap.getContext('2d');

async function setupCamera(){
  const st = await navigator.mediaDevices.getUserMedia({video:{width:640,height:480}});
  cam.srcObject = st;
  await cam.play();
  cap.width = cam.videoWidth || 640;
  cap.height= cam.videoHeight || 480;
  view.width = cap.width;
  view.height= cap.height;
}

async function sendFrame(){
  if (!running) return;
  const now = performance.now();
  if (now - lastSent < FRAME_INTERVAL) {
    requestAnimationFrame(sendFrame); return;
  }
  lastSent = now;

  // capture -> JPEG terkompres untuk hemat bandwidth
  capCtx.drawImage(cam, 0, 0, cap.width, cap.height);
  const blob = await new Promise(r => cap.toBlob(r, 'image/jpeg', 0.6));

  const form = new FormData();
  form.append('file', blob, 'frame.jpg');
  form.append('conf', conf.value);
  form.append('iou', iou.value);
  form.append('imgsz', imgsz.value);
  form.append('max_det', maxdet.value);

  statusEl.textContent = 'Status: inferencing...';
  try {
    const res = await fetch('/predict', { method:'POST', body: form });
    const js = await res.json();
    drawOverlay(js);
    statusEl.textContent = `Status: ${js.boxes.length} boxes`;
  } catch (e) {
    console.error(e);
    statusEl.textContent = 'Status: error (lihat console)';
  }
  requestAnimationFrame(sendFrame);
}

function drawOverlay(js){
  ctx.drawImage(cam, 0, 0, view.width, view.height);
  ctx.lineWidth = 2;
  ctx.font = '14px system-ui';
  ctx.strokeStyle = '#00ff00';
  ctx.fillStyle = 'rgba(0,0,0,0.65)';
  js.boxes.forEach(b=>{
    const [x1,y1,x2,y2] = b.xyxy;
    const w = x2 - x1, h = y2 - y1;
    ctx.beginPath();
    ctx.rect(x1, y1, w, h);
    ctx.stroke();
    const label = `${b.class} ${(b.conf*100).toFixed(1)}%`;
    const tw = ctx.measureText(label).width + 8;
    const th = 18;
    ctx.fillRect(x1, Math.max(0,y1-th), tw, th);
    ctx.fillStyle = '#fff';
    ctx.fillText(label, x1+4, Math.max(12,y1-4));
    ctx.fillStyle = 'rgba(0,0,0,0.65)';
  });
}

(async ()=>{
  await setupCamera();
  running = true;
  requestAnimationFrame(sendFrame);
})();
</script>
</body>
</html>
